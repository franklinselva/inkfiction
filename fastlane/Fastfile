default_platform(:ios)

platform :ios do

  # ==========================================
  # TESTING
  # ==========================================

  desc "Run all unit tests"
  lane :test do
    run_tests(
      scheme: "InkFiction",
      device: "iPhone Air",
      clean: true,
      code_coverage: true
    )
  end

  # ==========================================
  # BUILDING
  # ==========================================

  desc "Build the app for testing"
  lane :build do
    build_app(
      scheme: "InkFiction",
      destination: "platform=iOS Simulator,name=iPhone Air",
      skip_archive: true,
      skip_codesigning: true
    )
  end

  # ==========================================
  # TESTFLIGHT
  # ==========================================

  desc "Push a new beta build to TestFlight"
  lane :beta do
    ensure_git_status_clean

    increment_build_number(xcodeproj: "InkFiction.xcodeproj")

    build_app(
      scheme: "InkFiction",
      export_method: "app-store",
      xcargs: "-allowProvisioningUpdates"
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    commit_version_bump(
      xcodeproj: "InkFiction.xcodeproj",
      message: "Bump build number for TestFlight [skip ci]"
    )

    push_to_git_remote
  end

  # ==========================================
  # APP STORE
  # ==========================================

  desc "Push a new release build to the App Store"
  lane :release do |options|
    ensure_git_status_clean

    # Bump version based on options (patch by default)
    bump_type = options[:bump] || "patch"
    increment_version_number(
      xcodeproj: "InkFiction.xcodeproj",
      bump_type: bump_type
    )

    increment_build_number(xcodeproj: "InkFiction.xcodeproj")

    build_app(
      scheme: "InkFiction",
      export_method: "app-store",
      xcargs: "-allowProvisioningUpdates"
    )

    upload_to_app_store(
      skip_screenshots: true,
      skip_metadata: false,
      submit_for_review: false,
      automatic_release: false
    )

    version = get_version_number(xcodeproj: "InkFiction.xcodeproj")

    commit_version_bump(
      xcodeproj: "InkFiction.xcodeproj",
      message: "Release v#{version} [skip ci]"
    )

    add_git_tag(tag: "v#{version}")
    push_to_git_remote(tags: true)
  end

  # ==========================================
  # CERTIFICATES
  # ==========================================

  desc "Sync certificates and provisioning profiles"
  lane :certificates do
    match(type: "development", readonly: true)
    match(type: "appstore", readonly: true)
  end

  desc "Register new devices and regenerate profiles"
  lane :register_device do |options|
    device_name = options[:name]
    device_udid = options[:udid]

    register_devices(
      devices: {
        device_name => device_udid
      }
    )

    match(type: "development", force_for_new_devices: true)
  end

  # ==========================================
  # UTILITIES
  # ==========================================

  desc "Get current version number"
  lane :version do
    version = get_version_number(xcodeproj: "InkFiction.xcodeproj")
    build = get_build_number(xcodeproj: "InkFiction.xcodeproj")
    UI.message("Current version: #{version} (#{build})")
  end

  desc "Increment build number only"
  lane :bump_build do
    increment_build_number(xcodeproj: "InkFiction.xcodeproj")
    build = get_build_number(xcodeproj: "InkFiction.xcodeproj")
    UI.success("Build number bumped to #{build}")
  end

  desc "Clean build artifacts"
  lane :clean do
    clear_derived_data
    UI.success("Derived data cleared")
  end

end
